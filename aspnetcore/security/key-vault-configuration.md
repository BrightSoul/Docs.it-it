---
title: Provider di configurazione Azure insieme di credenziali chiave
author: guardrex
description: Informazioni su come utilizzare il Provider di configurazione dell'insieme di credenziali chiave di Azure per configurare un'applicazione che utilizza coppie nome-valore in fase di esecuzione.
keywords: ASP.NET Core, configurazione, l'insieme di credenziali chiave di Azure
ms.author: riande
manager: wpickett
ms.date: 08/09/2017
ms.topic: article
ms.assetid: 0292bdae-b3ed-4637-bd67-19b9bb8b65cb
ms.prod: asp.net-core
uid: security/key-vault-configuration
ms.openlocfilehash: 5122918ff84d87dd9763d454412f83d6f2c60fcb
ms.sourcegitcommit: 8005eb4051e568d88ee58d48424f39916052e6e2
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 09/24/2017
---
# <a name="azure-key-vault-configuration-provider"></a><span data-ttu-id="fa840-104">Provider di configurazione Azure insieme di credenziali chiave</span><span class="sxs-lookup"><span data-stu-id="fa840-104">Azure Key Vault configuration provider</span></span>

<span data-ttu-id="fa840-105">Da [Luke Latham](https://github.com/guardrex) e [Andrew Stanton-infermiera](https://github.com/anurse)</span><span class="sxs-lookup"><span data-stu-id="fa840-105">By [Luke Latham](https://github.com/guardrex) and [Andrew Stanton-Nurse](https://github.com/anurse)</span></span>

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[<span data-ttu-id="fa840-106">ASP.NET Core 2.x</span><span class="sxs-lookup"><span data-stu-id="fa840-106">ASP.NET Core 2.x</span></span>](#tab/aspnetcore2x)

<span data-ttu-id="fa840-107">Consente di visualizzare o scaricare il codice di esempio per 2. x:</span><span class="sxs-lookup"><span data-stu-id="fa840-107">View or download sample code for 2.x:</span></span>

* <span data-ttu-id="fa840-108">[Esempio di base](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/2.x) -legge i valori dei segreti in un'app.</span><span class="sxs-lookup"><span data-stu-id="fa840-108">[Basic sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/2.x) - Reads secret values into an app.</span></span>
* <span data-ttu-id="fa840-109">[Esempio di prefisso di nome della chiave](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/2.x) - legge i valori dei segreti mediante un prefisso del nome della chiave che rappresenta la versione di un'app, che consente di caricare un set diverso di valori segreti per ogni versione di app.</span><span class="sxs-lookup"><span data-stu-id="fa840-109">[Key name prefix sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/2.x) - Reads secret values using a key name prefix that represents the version of an app, which allows you to load a different set of secret values for each app version.</span></span>

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[<span data-ttu-id="fa840-110">ASP.NET Core 1.x</span><span class="sxs-lookup"><span data-stu-id="fa840-110">ASP.NET Core 1.x</span></span>](#tab/aspnetcore1x)

<span data-ttu-id="fa840-111">Consente di visualizzare o scaricare il codice di esempio per 1. x:</span><span class="sxs-lookup"><span data-stu-id="fa840-111">View or download sample code for 1.x:</span></span>

* <span data-ttu-id="fa840-112">[Esempio di base](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/1.x) -legge i valori dei segreti in un'app.</span><span class="sxs-lookup"><span data-stu-id="fa840-112">[Basic sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/1.x) - Reads secret values into an app.</span></span>
* <span data-ttu-id="fa840-113">[Esempio di prefisso di nome della chiave](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/1.x) - legge i valori dei segreti mediante un prefisso del nome della chiave che rappresenta la versione di un'app, che consente di caricare un set diverso di valori segreti per ogni versione di app.</span><span class="sxs-lookup"><span data-stu-id="fa840-113">[Key name prefix sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/1.x) - Reads secret values using a key name prefix that represents the version of an app, which allows you to load a different set of secret values for each app version.</span></span> 

---

<span data-ttu-id="fa840-114">Questo documento viene illustrato come utilizzare il [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) provider di configurazione da caricare i valori di configurazione dell'applicazione da segreti insieme credenziali chiavi Azure.</span><span class="sxs-lookup"><span data-stu-id="fa840-114">This document explains how to use the [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) configuration provider to load application configuration values from Azure Key Vault secrets.</span></span> <span data-ttu-id="fa840-115">Insieme di credenziali chiave di Azure è un servizio basato su cloud che consente di proteggere le chiavi di crittografia e i segreti utilizzati dall'App e servizi.</span><span class="sxs-lookup"><span data-stu-id="fa840-115">Azure Key Vault is a cloud-based service that helps you safeguard cryptographic keys and secrets used by apps and services.</span></span> <span data-ttu-id="fa840-116">Gli scenari comuni includono il controllo dell'accesso ai dati di configurazione sensibili e soddisfare il requisito per FIPS 140-2 livello 2 convalidata moduli di protezione Hardware (HSM) per l'archiviazione dei dati di configurazione.</span><span class="sxs-lookup"><span data-stu-id="fa840-116">Common scenarios include controlling access to sensitive configuration data and meeting the requirement for FIPS 140-2 Level 2 validated Hardware Security Modules (HSM's) when storing configuration data.</span></span> <span data-ttu-id="fa840-117">Questa funzionalità è disponibile per le applicazioni che utilizzano ASP.NET Core 1.1 o successiva.</span><span class="sxs-lookup"><span data-stu-id="fa840-117">This feature is available for applications that target ASP.NET Core 1.1 or higher.</span></span>

## <a name="package"></a><span data-ttu-id="fa840-118">Pacchetto</span><span class="sxs-lookup"><span data-stu-id="fa840-118">Package</span></span>
<span data-ttu-id="fa840-119">Per utilizzare il provider, aggiungere un riferimento di [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) pacchetto.</span><span class="sxs-lookup"><span data-stu-id="fa840-119">To use the provider, add a reference to the [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) package.</span></span>

## <a name="application-configuration"></a><span data-ttu-id="fa840-120">Configurazione dell'applicazione</span><span class="sxs-lookup"><span data-stu-id="fa840-120">Application configuration</span></span>
<span data-ttu-id="fa840-121">È possibile esplorare il provider con il [app di esempio](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span><span class="sxs-lookup"><span data-stu-id="fa840-121">You can explore the provider with the [sample apps](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span></span> <span data-ttu-id="fa840-122">Dopo un insieme di credenziali chiave di stabilire e creare i segreti nell'insieme di credenziali, le app di esempio vengono caricati i valori secret le relative configurazioni in modo sicuro e visualizzano nelle pagine Web.</span><span class="sxs-lookup"><span data-stu-id="fa840-122">Once you establish a key vault and create secrets in the vault, the sample apps securely load the secret values into their configurations and display them in webpages.</span></span>

<span data-ttu-id="fa840-123">Il provider viene aggiunto per il `ConfigurationBuilder` con il `AddAzureKeyVault` estensione.</span><span class="sxs-lookup"><span data-stu-id="fa840-123">The provider is added to the `ConfigurationBuilder` with the `AddAzureKeyVault` extension.</span></span> <span data-ttu-id="fa840-124">Nelle app di esempio, l'estensione utilizza tre valori di configurazione caricati dal *appSettings. JSON* file.</span><span class="sxs-lookup"><span data-stu-id="fa840-124">In the sample apps, the extension uses three configuration values loaded from the *appsettings.json* file.</span></span>

| <span data-ttu-id="fa840-125">Impostazione dell'App</span><span class="sxs-lookup"><span data-stu-id="fa840-125">App Setting</span></span>    | <span data-ttu-id="fa840-126">Descrizione</span><span class="sxs-lookup"><span data-stu-id="fa840-126">Description</span></span>                    | <span data-ttu-id="fa840-127">Esempio</span><span class="sxs-lookup"><span data-stu-id="fa840-127">Example</span></span>                                      |
| -------------- | ------------------------------ | -------------------------------------------- |
| `Vault`        | <span data-ttu-id="fa840-128">Nome insieme di credenziali chiave di Azure</span><span class="sxs-lookup"><span data-stu-id="fa840-128">Azure Key Vault name</span></span>           | <span data-ttu-id="fa840-129">contosovault</span><span class="sxs-lookup"><span data-stu-id="fa840-129">contosovault</span></span>                                 |
| `ClientId`     | <span data-ttu-id="fa840-130">Id di App di Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="fa840-130">Azure Active Directory App Id</span></span>  | <span data-ttu-id="fa840-131">627e911e-43CC-61d4-992e-12db9c81b413</span><span class="sxs-lookup"><span data-stu-id="fa840-131">627e911e-43cc-61d4-992e-12db9c81b413</span></span>         |
| `ClientSecret` | <span data-ttu-id="fa840-132">Chiave dell'applicazione Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="fa840-132">Azure Active Directory App Key</span></span> | <span data-ttu-id="fa840-133">g58K3dtg59o1Pa e59v2Tx829w6VxTB2yv9sv/101di + =</span><span class="sxs-lookup"><span data-stu-id="fa840-133">g58K3dtg59o1Pa+e59v2Tx829w6VxTB2yv9sv/101di=</span></span> |

[!code-csharp[Program](key-vault-configuration/samples/basic-sample/2.x/Program.cs?name=snippet1&highlight=2,7-10)]

## <a name="creating-key-vault-secrets-and-loading-configuration-values-basic-sample"></a><span data-ttu-id="fa840-134">Creazione di segreti dell'insieme di credenziali chiave e il caricamento dei valori di configurazione (esempio di base)</span><span class="sxs-lookup"><span data-stu-id="fa840-134">Creating key vault secrets and loading configuration values (basic-sample)</span></span>
1. <span data-ttu-id="fa840-135">Creare un insieme di credenziali chiave e configurare Azure Active Directory (Azure AD) per l'applicazione seguendo le istruzioni in [introduzione insieme credenziali chiavi Azure](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="fa840-135">Create a key vault and set up Azure Active Directory (Azure AD) for the application following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
  * <span data-ttu-id="fa840-136">Aggiungere i segreti alla chiave dell'insieme di credenziali utilizzando il [modulo PowerShell di insieme di credenziali chiave di Azure Resource Manager](/powershell/module/azurerm.keyvault) disponibile dal [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), il [API REST dell'insieme di credenziali chiave di Azure](/rest/api/keyvault/), o il [Portale di azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="fa840-136">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="fa840-137">I segreti vengono creati come *manuale* o *certificato* segreti.</span><span class="sxs-lookup"><span data-stu-id="fa840-137">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="fa840-138">*Certificato* segreti sono certificati per l'utilizzo da applicazioni e servizi, ma non sono supportati dal provider di configurazione.</span><span class="sxs-lookup"><span data-stu-id="fa840-138">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="fa840-139">È consigliabile utilizzare il *manuale* opzione per creare i segreti di coppia nome-valore per l'utilizzo con il provider di configurazione.</span><span class="sxs-lookup"><span data-stu-id="fa840-139">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
    * <span data-ttu-id="fa840-140">I segreti semplici vengono creati come coppie nome-valore.</span><span class="sxs-lookup"><span data-stu-id="fa840-140">Simple secrets are created as name-value pairs.</span></span> <span data-ttu-id="fa840-141">Azure insieme di credenziali chiave segreta i nomi sono limitati a caratteri alfanumerici e trattini.</span><span class="sxs-lookup"><span data-stu-id="fa840-141">Azure Key Vault secret names are limited to alphanumeric characters and dashes.</span></span>
    * <span data-ttu-id="fa840-142">Utilizzano valori gerarchici (sezioni di configurazione) `--` (due trattini) come separatore nell'esempio.</span><span class="sxs-lookup"><span data-stu-id="fa840-142">Hierarchical values (configuration sections) use `--` (two dashes) as a separator in the sample.</span></span> <span data-ttu-id="fa840-143">I due punti, che vengono generalmente utilizzati per la delimitazione di una sezione di una sottochiave [configurazione di ASP.NET Core](xref:fundamentals/configuration), non sono consentiti nei nomi dei segreti.</span><span class="sxs-lookup"><span data-stu-id="fa840-143">Colons, which are normally used to delimit a section from a subkey in [ASP.NET Core configuration](xref:fundamentals/configuration), aren't allowed in secret names.</span></span> <span data-ttu-id="fa840-144">Pertanto, due trattini vengono utilizzati e scambiati per i due punti, quando i segreti vengono caricati nella configurazione dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="fa840-144">Therefore, two dashes are used and swapped for a colon when the secrets are loaded into the app's configuration.</span></span>
    * <span data-ttu-id="fa840-145">Creare due *manuale* segreti con le seguenti coppie nome-valore.</span><span class="sxs-lookup"><span data-stu-id="fa840-145">Create two *Manual* secrets with the following name-value pairs.</span></span> <span data-ttu-id="fa840-146">Il segreto primo è un nome semplice e un valore e il segreto secondo crea un valore segreto con una sezione e una sottochiave nel nome del segreto:</span><span class="sxs-lookup"><span data-stu-id="fa840-146">The first secret is a simple name and value, and the second secret creates a secret value with a section and subkey in the secret name:</span></span>
      * <span data-ttu-id="fa840-147">`SecretName`: `secret_value_1`</span><span class="sxs-lookup"><span data-stu-id="fa840-147">`SecretName`: `secret_value_1`</span></span>
      * <span data-ttu-id="fa840-148">`Section--SecretName`: `secret_value_2`</span><span class="sxs-lookup"><span data-stu-id="fa840-148">`Section--SecretName`: `secret_value_2`</span></span>
  * <span data-ttu-id="fa840-149">Registrare l'app di esempio con Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="fa840-149">Register the sample app with Azure Active Directory.</span></span>
  * <span data-ttu-id="fa840-150">Autorizzare l'app per l'insieme di credenziali chiave di accesso.</span><span class="sxs-lookup"><span data-stu-id="fa840-150">Authorize the app to access the key vault.</span></span> <span data-ttu-id="fa840-151">Quando si utilizza il `Set-AzureRmKeyVaultAccessPolicy` fornisce cmdlet di PowerShell per autorizzare l'app per l'insieme di credenziali chiave di accesso `List` e `Get` accesso ai segreti con `-PermissionsToKeys list,get`.</span><span class="sxs-lookup"><span data-stu-id="fa840-151">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToKeys list,get`.</span></span>
2. <span data-ttu-id="fa840-152">Aggiornare l'app *appSettings. JSON* file con i valori di `Vault`, `ClientId`, e `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="fa840-152">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="fa840-153">Eseguire l'app di esempio, che ottiene i valori di configurazione da `IConfigurationRoot` con lo stesso nome come nome del segreto.</span><span class="sxs-lookup"><span data-stu-id="fa840-153">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the secret name.</span></span>
  * <span data-ttu-id="fa840-154">I valori non gerarchico: il valore per `SecretName` viene ottenuto con `config["SecretName"]`.</span><span class="sxs-lookup"><span data-stu-id="fa840-154">Non-hierarchical values: The value for `SecretName` is obtained with `config["SecretName"]`.</span></span>
  * <span data-ttu-id="fa840-155">I valori gerarchici (sezioni): utilizzare `:` notazione (virgola) o `GetSection` metodo di estensione.</span><span class="sxs-lookup"><span data-stu-id="fa840-155">Hierarchical values (sections): Use `:` (colon) notation or the `GetSection` extension method.</span></span> <span data-ttu-id="fa840-156">Per ottenere il valore di configurazione, utilizzare uno di questi approcci:</span><span class="sxs-lookup"><span data-stu-id="fa840-156">Use either of these approaches to obtain the configuration value:</span></span>
    * `config["Section:SecretName"]`
    * `config.GetSection("Section")["SecretName"]`

<span data-ttu-id="fa840-157">Quando si esegue l'app, una pagina Web Mostra i valori caricati segreti:</span><span class="sxs-lookup"><span data-stu-id="fa840-157">When you run the app, a webpage shows the loaded secret values:</span></span>

![Finestra del browser che mostra i valori dei segreti caricati tramite il Provider di configurazione dell'insieme di credenziali chiave di Azure](key-vault-configuration/_static/sample1.png)

## <a name="creating-prefixed-key-vault-secrets-and-loading-configuration-values-key-name-prefix-sample"></a><span data-ttu-id="fa840-159">Creazione di segreti con prefisso insieme di credenziali chiave e il caricamento dei valori di configurazione (tasto-nome-prefisso-esempio)</span><span class="sxs-lookup"><span data-stu-id="fa840-159">Creating prefixed key vault secrets and loading configuration values (key-name-prefix-sample)</span></span>
<span data-ttu-id="fa840-160">`AddAzureKeyVault`fornisce anche un overload che accetta un'implementazione di `IKeyVaultSecretManager`, che consente di controllare i segreti dell'insieme di credenziali chiave vengono convertiti in chiavi di configurazione.</span><span class="sxs-lookup"><span data-stu-id="fa840-160">`AddAzureKeyVault` also provides an overload that accepts an implementation of `IKeyVaultSecretManager`, which allows you to control how key vault secrets are converted into configuration keys.</span></span> <span data-ttu-id="fa840-161">Ad esempio, è possibile implementare l'interfaccia per caricare i valori dei segreti basati su un valore di prefisso che è fornire all'avvio dell'app.</span><span class="sxs-lookup"><span data-stu-id="fa840-161">For example, you can implement the interface to load secret values based on a prefix value you provide at app startup.</span></span> <span data-ttu-id="fa840-162">Questo consente, ad esempio, per caricare i segreti in base alla versione dell'app.</span><span class="sxs-lookup"><span data-stu-id="fa840-162">This allows you, for example, to load secrets based on the version of the app.</span></span>

> [!WARNING]
> <span data-ttu-id="fa840-163">Non utilizzare i prefissi su segreti dell'insieme di credenziali chiave inserire stesso insieme di credenziali chiave di segreti per più applicazioni o di posizionare i segreti dell'ambiente (ad esempio, *sviluppo* verus *produzione* segreti) nella stessa insieme di credenziali.</span><span class="sxs-lookup"><span data-stu-id="fa840-163">Don't use prefixes on key vault secrets to place secrets for multiple apps into the same key vault or to place environmental secrets (for example, *development* verus *production* secrets) into the same vault.</span></span> <span data-ttu-id="fa840-164">È consigliabile che diverse App e gli ambienti di sviluppo/produzione usare gli insiemi di credenziali chiave separati per isolare gli ambienti di app per il massimo livello di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="fa840-164">We recommend that different apps and development/production environments use separate key vaults to isolate app environments for the highest level of security.</span></span>

<span data-ttu-id="fa840-165">Utilizza la seconda applicazione di esempio, creare un segreto nell'insieme di credenziali chiave per `5000-AppSecret` (periodi non sono consentiti nei nomi di insieme di credenziali chiave privata) che rappresenta un segreto dell'app per la versione 5.0.0.0 dell'app.</span><span class="sxs-lookup"><span data-stu-id="fa840-165">Using the second sample app, you create a secret in the key vault for `5000-AppSecret` (periods aren't allowed in key vault secret names) representing an app secret for version 5.0.0.0 of your app.</span></span> <span data-ttu-id="fa840-166">Per un'altra versione, 5.1.0.0, si crea una chiave privata per `5100-AppSecret`.</span><span class="sxs-lookup"><span data-stu-id="fa840-166">For another version, 5.1.0.0, you create a secret for `5100-AppSecret`.</span></span> <span data-ttu-id="fa840-167">Ogni versione di app carica il proprio valore segreto nella relativa configurazione come `AppSecret`, stripping la versione durante il caricamento del segreto.</span><span class="sxs-lookup"><span data-stu-id="fa840-167">Each app version loads its own secret value into its configuration as `AppSecret`, stripping off the version as it loads the secret.</span></span> <span data-ttu-id="fa840-168">Implementazione dell'esempio è illustrato di seguito:</span><span class="sxs-lookup"><span data-stu-id="fa840-168">The sample's implementation is shown below:</span></span>

[!code-csharp[Configuration builder](key-vault-configuration/samples/key-name-prefix-sample/2.x/Program.cs?name=snippet1&highlight=12)]

[!code-csharp[PrefixKeyVaultSecretManager](key-vault-configuration/samples/key-name-prefix-sample/2.x/Startup.cs?name=snippet1)]

<span data-ttu-id="fa840-169">Il `Load` metodo viene chiamato da un algoritmo di provider che scorre i segreti dell'insieme di credenziali per individuare quelli che dispongono del prefisso di versione.</span><span class="sxs-lookup"><span data-stu-id="fa840-169">The `Load` method is called by a provider algorithm that iterates through the vault secrets to find the ones that have the version prefix.</span></span> <span data-ttu-id="fa840-170">Quando un prefisso di versione è stato trovato con `Load`, l'algoritmo utilizza il `GetKey` per restituire il nome di configurazione del nome del segreto.</span><span class="sxs-lookup"><span data-stu-id="fa840-170">When a version prefix is found with `Load`, the algorithm uses the `GetKey` method to return the configuration name of the secret name.</span></span> <span data-ttu-id="fa840-171">Rimuove il prefisso di versione dal nome del segreto e restituisce il resto del nome del segreto per il caricamento nella configurazione dell'app coppie nome-valore.</span><span class="sxs-lookup"><span data-stu-id="fa840-171">It strips off the version prefix from the secret's name and returns the rest of the secret name for loading into the app's configuration name-value pairs.</span></span>

<span data-ttu-id="fa840-172">Quando si implementa questo approccio:</span><span class="sxs-lookup"><span data-stu-id="fa840-172">When you implement this approach:</span></span>

1. <span data-ttu-id="fa840-173">I segreti dell'insieme di credenziali chiave vengono caricati.</span><span class="sxs-lookup"><span data-stu-id="fa840-173">The key vault secrets are loaded.</span></span>
2. <span data-ttu-id="fa840-174">Il segreto di stringa per `5000-AppSecret` viene trovata una corrispondenza.</span><span class="sxs-lookup"><span data-stu-id="fa840-174">The string secret for `5000-AppSecret` is matched.</span></span>
3. <span data-ttu-id="fa840-175">La versione, `5000` (con il trattino), viene rimossa da lasciare il nome della chiave `AppSecret` per caricare con valore segreto nella configurazione dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="fa840-175">The version, `5000` (with the dash), is stripped off of the key name leaving `AppSecret` to load with the secret value into the app's configuration.</span></span>

> [!NOTE]
> <span data-ttu-id="fa840-176">È anche possibile fornire una propria `KeyVaultClient` implementazione `AddAzureKeyVault`.</span><span class="sxs-lookup"><span data-stu-id="fa840-176">You can also provide your own `KeyVaultClient` implementation to `AddAzureKeyVault`.</span></span> <span data-ttu-id="fa840-177">Fornisce un client personalizzato consente di condividere una singola istanza del client tra il provider di configurazione e altre parti dell'app.</span><span class="sxs-lookup"><span data-stu-id="fa840-177">Supplying a custom client allows you to share a single instance of the client between the configuration provider and other parts of your app.</span></span>

1. <span data-ttu-id="fa840-178">Creare un insieme di credenziali chiave e configurare Azure Active Directory (Azure AD) per l'applicazione seguendo le istruzioni in [introduzione insieme credenziali chiavi Azure](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="fa840-178">Create a key vault and set up Azure Active Directory (Azure AD) for the application following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
  * <span data-ttu-id="fa840-179">Aggiungere i segreti alla chiave dell'insieme di credenziali utilizzando il [modulo PowerShell di insieme di credenziali chiave di Azure Resource Manager](/powershell/module/azurerm.keyvault) disponibile dal [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), il [API REST dell'insieme di credenziali chiave di Azure](/rest/api/keyvault/), o il [Portale di azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="fa840-179">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="fa840-180">I segreti vengono creati come *manuale* o *certificato* segreti.</span><span class="sxs-lookup"><span data-stu-id="fa840-180">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="fa840-181">*Certificato* segreti sono certificati per l'utilizzo da applicazioni e servizi, ma non sono supportati dal provider di configurazione.</span><span class="sxs-lookup"><span data-stu-id="fa840-181">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="fa840-182">È consigliabile utilizzare il *manuale* opzione per creare i segreti di coppia nome-valore per l'utilizzo con il provider di configurazione.</span><span class="sxs-lookup"><span data-stu-id="fa840-182">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
    * <span data-ttu-id="fa840-183">Utilizzano valori gerarchici (sezioni di configurazione) `--` (due trattini) come separatore.</span><span class="sxs-lookup"><span data-stu-id="fa840-183">Hierarchical values (configuration sections) use `--` (two dashes) as a separator.</span></span>
    * <span data-ttu-id="fa840-184">Creare due *manuale* segreti con le coppie nome-valore seguente:</span><span class="sxs-lookup"><span data-stu-id="fa840-184">Create two *Manual* secrets with the following name-value pairs:</span></span>
      * <span data-ttu-id="fa840-185">`5000-AppSecret`: `5.0.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="fa840-185">`5000-AppSecret`: `5.0.0.0_secret_value`</span></span>
      * <span data-ttu-id="fa840-186">`5100-AppSecret`: `5.1.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="fa840-186">`5100-AppSecret`: `5.1.0.0_secret_value`</span></span>
  * <span data-ttu-id="fa840-187">Registrare l'app di esempio con Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="fa840-187">Register the sample app with Azure Active Directory.</span></span>
  * <span data-ttu-id="fa840-188">Autorizzare l'app per l'insieme di credenziali chiave di accesso.</span><span class="sxs-lookup"><span data-stu-id="fa840-188">Authorize the app to access the key vault.</span></span> <span data-ttu-id="fa840-189">Quando si utilizza il `Set-AzureRmKeyVaultAccessPolicy` fornisce cmdlet di PowerShell per autorizzare l'app per l'insieme di credenziali chiave di accesso `List` e `Get` accesso ai segreti con `-PermissionsToKeys list,get`.</span><span class="sxs-lookup"><span data-stu-id="fa840-189">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToKeys list,get`.</span></span>
2. <span data-ttu-id="fa840-190">Aggiornare l'app *appSettings. JSON* file con i valori di `Vault`, `ClientId`, e `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="fa840-190">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="fa840-191">Eseguire l'app di esempio, che ottiene i valori di configurazione da `IConfigurationRoot` con lo stesso nome come nome del segreto con prefisso.</span><span class="sxs-lookup"><span data-stu-id="fa840-191">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the prefixed secret name.</span></span> <span data-ttu-id="fa840-192">In questo esempio, il prefisso è la versione dell'app, che è fornito per il `PrefixKeyVaultSecretManager` quando è stato aggiunto il provider di configurazione insieme credenziali chiavi Azure.</span><span class="sxs-lookup"><span data-stu-id="fa840-192">In this sample, the prefix is the app's version, which you provided to the `PrefixKeyVaultSecretManager` when you added the Azure Key Vault configuration provider.</span></span> <span data-ttu-id="fa840-193">Il valore per `AppSecret` viene ottenuto con `config["AppSecret"]`.</span><span class="sxs-lookup"><span data-stu-id="fa840-193">The value for `AppSecret` is obtained with `config["AppSecret"]`.</span></span> <span data-ttu-id="fa840-194">La pagina Web generata dall'app Mostra il valore caricato:</span><span class="sxs-lookup"><span data-stu-id="fa840-194">The webpage generated by the app shows the loaded value:</span></span>

   ![Finestra del browser che mostra un valore segreto caricato tramite il Provider di configurazione dell'insieme di credenziali chiave di Azure quando la versione dell'app è 5.0.0.0](key-vault-configuration/_static/sample2-1.png)

4. <span data-ttu-id="fa840-196">Modificare la versione dell'assembly nel file di progetto da app `5.0.0.0` a `5.1.0.0` ed eseguire nuovamente l'app.</span><span class="sxs-lookup"><span data-stu-id="fa840-196">Change the version of the app assembly in the project file from `5.0.0.0` to `5.1.0.0` and run the app again.</span></span> <span data-ttu-id="fa840-197">Questa volta, il valore secret restituito è `5.1.0.0_secret_value`.</span><span class="sxs-lookup"><span data-stu-id="fa840-197">This time, the secret value returned is `5.1.0.0_secret_value`.</span></span> <span data-ttu-id="fa840-198">La pagina Web generata dall'app Mostra il valore caricato:</span><span class="sxs-lookup"><span data-stu-id="fa840-198">The webpage generated by the app shows the loaded value:</span></span>

   ![Finestra del browser che mostra un valore segreto caricato tramite il Provider di configurazione dell'insieme di credenziali chiave di Azure quando la versione dell'app è 5.1.0.0](key-vault-configuration/_static/sample2-2.png)

## <a name="controlling-access-to-the-clientsecret"></a><span data-ttu-id="fa840-200">Controllo dell'accesso per il ClientSecret</span><span class="sxs-lookup"><span data-stu-id="fa840-200">Controlling access to the ClientSecret</span></span>
<span data-ttu-id="fa840-201">Utilizzare il [lo strumento Gestione segreto](xref:security/app-secrets) per mantenere il `ClientSecret` di fuori di struttura di origine del progetto.</span><span class="sxs-lookup"><span data-stu-id="fa840-201">Use the [Secret Manager tool](xref:security/app-secrets) to maintain the `ClientSecret` outside of your project source tree.</span></span> <span data-ttu-id="fa840-202">Con gestione segreto, associare i segreti dell'app a un progetto specifico e condividerli tra più progetti.</span><span class="sxs-lookup"><span data-stu-id="fa840-202">With Secret Manager, you associate app secrets with a specific project and share them across multiple projects.</span></span>

<span data-ttu-id="fa840-203">Quando si sviluppa un'app .NET Framework in un ambiente che supporta i certificati, è possibile autenticare l'insieme di credenziali chiave di Azure con un certificato x. 509.</span><span class="sxs-lookup"><span data-stu-id="fa840-203">When developing a .NET Framework app in an environment that supports certificates, you can authenticate to Azure Key Vault with an X.509 certificate.</span></span> <span data-ttu-id="fa840-204">Chiave privata del certificato x. 509 è gestita dal sistema operativo.</span><span class="sxs-lookup"><span data-stu-id="fa840-204">The X.509 certificate's private key is managed by the OS.</span></span> <span data-ttu-id="fa840-205">Per ulteriori informazioni, vedere [eseguire l'autenticazione con un certificato anziché un segreto Client](https://docs.microsoft.com/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span><span class="sxs-lookup"><span data-stu-id="fa840-205">For more information, see [Authenticate with a Certificate instead of a Client Secret](https://docs.microsoft.com/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span></span> <span data-ttu-id="fa840-206">Utilizzare il `AddAzureKeyVault` overload che accetta un `X509Certificate2`.</span><span class="sxs-lookup"><span data-stu-id="fa840-206">Use the `AddAzureKeyVault` overload that accepts an `X509Certificate2`.</span></span>

```csharp
var store = new X509Store(StoreLocation.CurrentUser);
store.Open(OpenFlags.ReadOnly);
var cert = store.Certificates.Find(X509FindType.FindByThumbprint, config["CertificateThumbprint"], false);

builder.AddAzureKeyVault(
    config["Vault"],
    config["ClientId"],
    cert.OfType<X509Certificate2>().Single(),
    new EnvironmentSecretManager(env.ApplicationName));
store.Close();

Configuration = builder.Build();
```

## <a name="reloading-secrets"></a><span data-ttu-id="fa840-207">Ricaricare i segreti</span><span class="sxs-lookup"><span data-stu-id="fa840-207">Reloading secrets</span></span>
<span data-ttu-id="fa840-208">I segreti vengono memorizzati nella cache fino a quando `IConfigurationRoot.Reload()` viene chiamato.</span><span class="sxs-lookup"><span data-stu-id="fa840-208">Secrets are cached until `IConfigurationRoot.Reload()` is called.</span></span> <span data-ttu-id="fa840-209">Scaduto, disabilitato, e per l'applicazione fino a quando non viene rispettati aggiornato i segreti nell'insieme di credenziali chiave `Reload` viene eseguita.</span><span class="sxs-lookup"><span data-stu-id="fa840-209">Expired, disabled, and updated secrets in the key vault are not respected by the application until `Reload` is executed.</span></span>

```csharp
Configuration.Reload();
```

## <a name="disabled-and-expired-secrets"></a><span data-ttu-id="fa840-210">Segreti disabilitati e scaduti</span><span class="sxs-lookup"><span data-stu-id="fa840-210">Disabled and expired secrets</span></span>
<span data-ttu-id="fa840-211">Generano i segreti disabilitati e scaduti un `KeyVaultClientException`.</span><span class="sxs-lookup"><span data-stu-id="fa840-211">Disabled and expired secrets throw a `KeyVaultClientException`.</span></span> <span data-ttu-id="fa840-212">Per impedire la generazione dell'app, sostituire l'app o aggiorna il segreto disabilitato o scaduto.</span><span class="sxs-lookup"><span data-stu-id="fa840-212">To prevent your app from throwing, replace your app or update the disabled/expired secret.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="fa840-213">Risoluzione dei problemi</span><span class="sxs-lookup"><span data-stu-id="fa840-213">Troubleshooting</span></span>
<span data-ttu-id="fa840-214">Quando l'applicazione non riesce a caricare la configurazione utilizzando il provider, viene scritto un messaggio di errore di [dell'infrastruttura di registrazione di ASP.NET](xref:fundamentals/logging).</span><span class="sxs-lookup"><span data-stu-id="fa840-214">When the application fails to load configuration using the provider, an error message is written to the [ASP.NET Logging infrastructure](xref:fundamentals/logging).</span></span> <span data-ttu-id="fa840-215">Le condizioni seguenti impedirà la configurazione da caricare:</span><span class="sxs-lookup"><span data-stu-id="fa840-215">The following conditions will prevent configuration from loading:</span></span>
* <span data-ttu-id="fa840-216">L'app non è configurato correttamente in Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="fa840-216">The app isn't configured correctly in Azure Active Directory.</span></span>
* <span data-ttu-id="fa840-217">L'insieme di credenziali chiave non esiste nell'insieme di credenziali chiave di Azure.</span><span class="sxs-lookup"><span data-stu-id="fa840-217">The key vault doesn't exist in Azure Key Vault.</span></span>
* <span data-ttu-id="fa840-218">L'app non è autorizzato ad accedere l'insieme di credenziali chiave.</span><span class="sxs-lookup"><span data-stu-id="fa840-218">The app isn't authorized to access the key vault.</span></span>
* <span data-ttu-id="fa840-219">Non includono i criteri di accesso `Get` e `List` le autorizzazioni.</span><span class="sxs-lookup"><span data-stu-id="fa840-219">The access policy doesn't include `Get` and `List` permissions.</span></span>
* <span data-ttu-id="fa840-220">Nell'insieme di credenziali chiave, i dati di configurazione (coppia nome-valore) in modo corretto il nome sono mancante, disabilitato o scaduto.</span><span class="sxs-lookup"><span data-stu-id="fa840-220">In the key vault, the configuration data (name-value pair) is incorrectly named, missing, disabled, or expired.</span></span>
* <span data-ttu-id="fa840-221">L'app con il nome dell'insieme di credenziali chiave errata (`Vault`), Id di App di Azure Active Directory (`ClientId`), o la chiave di Azure AD (`ClientSecret`).</span><span class="sxs-lookup"><span data-stu-id="fa840-221">The app has the wrong key vault name (`Vault`), Azure AD App Id (`ClientId`), or Azure AD Key (`ClientSecret`).</span></span>
* <span data-ttu-id="fa840-222">La chiave di Azure Active Directory (`ClientSecret`) è scaduto.</span><span class="sxs-lookup"><span data-stu-id="fa840-222">The Azure AD Key (`ClientSecret`) is expired.</span></span>
* <span data-ttu-id="fa840-223">Non è corretta nell'app per il valore di cui che si sta provando a caricare la chiave di configurazione (nome).</span><span class="sxs-lookup"><span data-stu-id="fa840-223">The configuration key (name) is incorrect in the app for the value you're trying to load.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="fa840-224">Risorse aggiuntive</span><span class="sxs-lookup"><span data-stu-id="fa840-224">Additional resources</span></span>
* <xref:fundamentals/configuration>
* [<span data-ttu-id="fa840-225">Microsoft Azure: Insieme di credenziali chiave</span><span class="sxs-lookup"><span data-stu-id="fa840-225">Microsoft Azure: Key Vault</span></span>](https://azure.microsoft.com/services/key-vault/)
* [<span data-ttu-id="fa840-226">Microsoft Azure: Documentazione dell'insieme di credenziali chiave</span><span class="sxs-lookup"><span data-stu-id="fa840-226">Microsoft Azure: Key Vault Documentation</span></span>](https://docs.microsoft.com/azure/key-vault/)
* [<span data-ttu-id="fa840-227">Come generare e trasferire HSM protetta di chiavi per l'insieme di credenziali chiave di Azure</span><span class="sxs-lookup"><span data-stu-id="fa840-227">How to generate and transfer HSM-protected keys for Azure Key Vault</span></span>](https://docs.microsoft.com/azure/key-vault/key-vault-hsm-protected-keys)
* [<span data-ttu-id="fa840-228">Classe KeyVaultClient</span><span class="sxs-lookup"><span data-stu-id="fa840-228">KeyVaultClient Class</span></span>](https://docs.microsoft.com/dotnet/api/microsoft.azure.keyvault.keyvaultclient)
